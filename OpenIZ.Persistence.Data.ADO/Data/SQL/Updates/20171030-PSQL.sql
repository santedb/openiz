/** 
 * <update id="20171030-01" applyRange="0.2.0.7-0.9.9.0"  invariantName="npgsql">
 *	<summary>Adds the Procedure table to the OpenIZ schema</summary>
 *	<remarks></remarks>
 * </update>
 */

BEGIN TRANSACTION ;
CREATE OR REPLACE FUNCTION squash_db() AS $$
BEGIN

begin transaction;

--RAISE INFO 'PRUNING ADDRESSES';
DELETE FROM ENT_ADDR_CMP_TBL WHERE ADDR_ID IN (SELECT ADDR_ID FROM ENT_ADDR_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL);
DELETE FROM ENT_ADDR_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
-- NO CURRENT VERSIONS EXIST?
DELETE FROM ENT_ADDR_CMP_TBL WHERE ADDR_ID IN (SELECT ADDR_ID FROM ENT_ADDR_TBL WHERE NOT EXISTS(SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_ADDR_TBL.ENT_ID) AND OBSLT_VRSN_SEQ_ID IS NULL);
DELETE FROM ENT_ADDR_TBL WHERE NOT EXISTS(SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_ADDR_TBL.ENT_ID) AND OBSLT_VRSN_SEQ_ID IS NULL;
UPDATE ENT_ADDR_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_ADDR_TBL.ENT_ID LIMIT 1);

--RAISE INFO 'PRUNING NAMES';
DELETE FROM ENT_NAME_CMP_TBL WHERE NAME_ID IN (SELECT NAME_ID FROM ENT_NAME_TBL WHERE OBSLT_VRSN_SEQ_ID  IS NOT NULL);
DELETE FROM ENT_NAME_TBL WHERE OBSLT_VRSN_SEQ_ID  IS NOT NULL;
-- NO CURRENT VERSIONS EXIST?
DELETE FROM ENT_NAME_CMP_TBL WHERE NAME_ID IN (SELECT NAME_ID FROM ENT_NAME_TBL WHERE NOT EXISTS(SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_NAME_TBL.ENT_ID) AND OBSLT_VRSN_SEQ_ID IS NULL);
DELETE FROM ENT_NAME_TBL WHERE NOT EXISTS(SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_NAME_TBL.ENT_ID) AND OBSLT_VRSN_SEQ_ID IS NULL;
UPDATE ENT_NAME_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_NAME_TBL.ENT_ID LIMIT 1);

--RAISE INFO 'PRUNING IDENTIFIERS';
DELETE FROM ENT_ID_TBL WHERE OBSLT_VRSN_SEQ_ID  IS NOT NULL;
DELETE FROM ENT_ID_TBL WHERE NOT EXISTS(SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_ID_TBL.ENT_ID) AND OBSLT_VRSN_SEQ_ID IS NULL;
DELETE FROM ENT_ID_TBL WHERE EXISTS (SELECT * FROM ENT_ID_TBL B WHERE ENT_ID_TBL.EFFT_VRSN_SEQ_ID <> B.EFFT_VRSN_SEQ_ID AND ENT_ID_TBL.ENT_ID = B.ENT_ID AND B.EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = B.ENT_ID LIMIT 1) AND B.AUT_ID = ENT_ID_TBL.AUT_ID AND B.ID_VAL = ENT_ID_TBL.ID_VAL);
UPDATE ENT_ID_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_ID_TBL.ENT_ID LIMIT 1);

--RAISE INFO 'PRUNING TELECOM ADDRESSES';
DELETE FROM ENT_TEL_TBL WHERE OBSLT_VRSN_SEQ_ID  IS NOT NULL;
UPDATE ENT_TEL_TBL  SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_TEL_TBL.ENT_ID LIMIT 1);

--RAISE INFO 'PRUNING EXTENSIONS';
DELETE FROM ENT_EXT_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
DELETE FROM ENT_EXT_TBL WHERE NOT EXISTS(SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_EXT_TBL.ENT_ID) AND OBSLT_VRSN_SEQ_ID IS NULL;
UPDATE ENT_EXT_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_EXT_TBL.ENT_ID LIMIT 1);

--RAISE INFO 'PRUNING PATIENTS';
DELETE FROM PAT_TBL WHERE ENT_VRSN_ID IN (SELECT ENT_VRSN_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC  IS NOT NULL);

--RAISE INFO 'PRUNING PROVIDERS';
DELETE FROM PVDR_TBL WHERE ENT_VRSN_ID IN (SELECT ENT_VRSN_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC  IS NOT NULL);

--RAISE INFO 'PRUNING USERS';
DELETE FROM USR_ENT_TBL WHERE ENT_VRSN_ID IN (SELECT ENT_VRSN_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC  IS NOT NULL);

--RAISE INFO 'PRUNING PERSONS';
DELETE FROM PSN_LNG_TBL WHERE OBSLT_VRSN_SEQ_ID  IS NOT NULL;
UPDATE PSN_LNG_TBL  SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = PSN_LNG_TBL.ENT_ID LIMIT 1);
DELETE FROM PSN_TBL WHERE ENT_VRSN_ID IN (SELECT ENT_VRSN_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC  IS NOT NULL);

--RAISE INFO 'PRUNING PLACES';
DELETE FROM PLC_TBL WHERE ENT_VRSN_ID IN (SELECT ENT_VRSN_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC  IS NOT NULL);

--RAISE INFO 'PRUNING ORGANIZATIONS';
DELETE FROM ORG_TBL WHERE ENT_VRSN_ID IN (SELECT ENT_VRSN_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC  IS NOT NULL);

--RAISE INFO 'PRUNING ENTITY RELATIONSHIPS';
DELETE FROM ENT_REL_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
UPDATE ENT_REL_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ENT_ID = ENT_REL_TBL.SRC_ENT_ID LIMIT 1);

-- DELETE FROM ENT VRSN TBL 
UPDATE ENT_VRSN_TBL SET RPLC_VRSN_ID = NULL WHERE OBSLT_UTC IS NULL;
DELETE FROM ENT_VRSN_TBL WHERE OBSLT_UTC IS NOT NULL ;
rollback ;

-- RAISE INFO 'PRUNING ACT IDENTIFIERS';
DELETE FROM ACT_ID_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
UPDATE ACT_ID_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ACT_ID = ACT_ID_TBL.ACT_ID LIMIT 1) WHERE OBSLT_VRSN_SEQ_ID IS NULL;

--RAISE INFO 'PRUNING ACT EXTENSIONS';
DELETE FROM ACT_EXT_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
UPDATE ACT_EXT_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ACT_ID = ACT_EXT_TBL.ENT_ID LIMIT 1) WHERE OBSLT_VRSN_SEQ_ID IS NULL;

--RAISE INFO 'PRUNING OBSERVATIONS';
DELETE FROM QTY_OBS_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );
DELETE FROM TXT_OBS_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );
DELETE FROM CD_OBS_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );
DELETE FROM OBS_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );

--RAISE INFO 'PRUNING SUBSTANCE ADMINISTRATIONS';
DELETE FROM SUB_ADM_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );

--RAISE INFO 'PRUNING ENCOUNTERS';
DELETE FROM PAT_ENC_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );

--RAISE INFO 'PRUNING PROCEDURES';
DELETE FROM PROC_TBL WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );

--RAISE INFO 'PRUNING ACT RELATIONSHIPS';
DELETE FROM ACT_REL_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
UPDATE ACT_REL_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ACT_ID = ACT_REL_TBL.SRC_ACT_ID LIMIT 1);

--RAISE INFO 'PRUNING ACT PARTICIPATIONS';
DELETE FROM ACT_PTCPT_TBL WHERE OBSLT_VRSN_SEQ_ID IS NOT NULL;
UPDATE ACT_PTCPT_TBL SET EFFT_VRSN_SEQ_ID = (SELECT VRSN_SEQ_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC IS NULL AND ACT_ID = ACT_PTCPT_TBL.ACT_ID LIMIT 1);

--RAISE INFO 'PRUNING ACT VERSIONS';
DELETE FROM WHERE ACT_VRSN_ID IN (SELECT ACT_VRSN_ID FROM ACT_VRSN_TBL WHERE OBSLT_UTC < CURRENT_TIMESTAMP - '1 DAY'::INTERVAL );

END;
$$ LANGUAGE plpgsql;
 -- GET THE SCHEMA VERSION
CREATE OR REPLACE FUNCTION GET_SCH_VRSN() RETURNS VARCHAR(10) AS
$$
BEGIN
	RETURN '0.9.9.0';
END;
$$ LANGUAGE plpgsql;

COMMIT;